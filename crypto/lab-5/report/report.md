# Лабораторная работа №5 по курсу "Криптография"

## Тема

Темой данной лабораторной работы является исследование эллиптических кривых над конечным простым полем $\mathbb{Z}_p$, определение порядка точки с использованием полного перебора, а также анализ времени выполнения и характеристик вычислителя. В работе также рассматриваются алгоритмы и теоремы, которые могут быть использованы для ускорения и облегчения решения задачи полного перебора.

## Задание

1. Подобрать такую эллиптическую кривую, порядок точки которой полным перебором находится за 10 минут на ПК;

2. Упомянуть в отчёте результаты замеров работы программы, характеристики вычислителя;

3. Указать какие алгоритмы и/или теоремы существуют для облегчения и ускорения решения задачи полного перебора.

Рассмотреть для случая конечного простого поля $\mathbb{Z}_p$.

## Теория

### Эллиптические кривые

Эллиптические кривые представляют собой специальный вид кривых, которые описываются уравнением Вейерштрасса:

$$
y ^ 2 = x ^ 3 + a \cdot x + b
$$

В криптографии также накладывается дополнительное ограничение на эллиптические кривые: $4 \cdot a ^ 3 + 27 \cdot b ^ 2 \ne 0$. Кривые, удовлетворяющие этому условию, называются **гладкими**.

### Операция сложения

Мы можем также определить на эллиптической кривой алгебру. 

**Сложение трех точек** на эллиптической кривой обычно определяется следующим образом: если мы имеем три точки $A$, $B$ и $C$ на кривой, и они лежат на одной прямой, то их сумма равна нулю (то есть $A + B + C = 0$). Если мы хотим сложить только две точки, скажем $A$ и $B$, мы просто берем точку $C$, которая является третьей точкой на прямой через $A$ и $B$, и определяем $A + B$ как обратную к $C$. Если же $A = B$, то точка $C$ является точкой пересечения касательной в точке $A$ с кривой.

**Обратной точкой** точке $A$ будем называть точку $(-A) = (A_x - A_y)$, которая является зеркальной версией точки $A$ относительно оси $OX$.

**Нулевая точка** на эллиптической кривой представляет собой "точку в бесконечности". Она играет роль нейтрального элемента в группе, определенной на кривой. Это означает, что для любой точки $P$ на кривой выполняется равенство $P + 0 = P$. Кроме того, если точка $P$ находится на кривой, то $P + (-P) = 0$.

### Кривые над конечным полем

В криптографии используется специальный вид кривых, которые определены на конечном поле. Это поле представляет собой кольцо вычетов по модулю простого числа. Такое поле обычно обозначается как $\mathbb{Z}_p$ и содержит целые положительные числа в диапазоне $[0 \ .. \ (p - 1)]$. Точки на такой кривой должны удовлетворять следующему равенству:

$$
y ^ 2 = (x ^ 3 + a \cdot x + b) \mod p
$$

То есть, все операции проводятся в контексте модуля $p$.

На таком кольце определены операции сложения, вычитания, умножения по модулю. Также, над кольцом определена операция дискретного логарифма, который на самом деле представляет собой аналог операции "деления" над полем $\mathbb{Z}_p$.

### Особенности сложения

Операция сложения в таком поле имеет свои особенности. Если мы складываем две точки $P = (x_1, y_1)$ и $Q = (x_2, y_2)$ на эллиптической кривой, результатом будет точка $R = (x_3, y_3)$, где:

$$
\begin{matrix}
    x_3 = \lambda ^ 2 - x_1 - x_2 \mod p \\
    y_3 = \lambda \cdot (x_1 - x_3) - y_1 \mod p \\
\end{matrix}
$$

здесь $\lambda$ представляет наклон прямой, проходящей через точки $P$ и $Q$.

### Порядок

**Порядок кривой** соответствует количеству точек на кривой, включая точку в бесконечности. В контексте эллиптической кривой, порядок точки $P$ означает такое наименьшее положительное число $n$, при котором $n \cdot P = O$, где $O$ - это точка в бесконечности, а $n \cdot P$ - это результат сложения точки $P$ самой с собой $n$ раз.

### Задача дискретного логарифмирования

В контексте эллиптических кривых, задача дискретного логарифмирования формулируется следующим образом. Пусть даны точки $P$, $Q$ на эллиптической кривой, и требуется найти такое целое число $n$, которое будет удовлетворять следующему равенству

$$
n \cdot P = Q
$$

где $n \cdot P$ означает результат сложения точки $P$ с самой собой $n$ раз.

Такая задача является на текущей момент "сложной". То есть, не было придумано алгоритма, который смог бы решить поставленную задачу за приемлемое время. Если бы был найден эффективный алгоритм для решения этой задачи, то большинство современных криптосистем стали бы небезопасными.

Сложность задачи дискретного логарифмирования в контексте эллиптических кривых обусловлена тем, что операции на эллиптических кривых отличаются от операций в обычных группах. В частности, операция сложения на эллиптической кривой не является коммутативной, что затрудняет применение многих известных алгоритмов. Кроме того, эффективные алгоритмы для решения задачи дискретного логарифмирования в других группах, таких как группа целых чисел по модулю  $p$, не могут быть применены к эллиптическим кривым, что делает задачу дискретного логарифмирования на них особенно сложной.

## Ход лабораторной работы

Перед описанием выполнения лабораторной работы стоит отметить, что конечно весь процесс можно было бы сократить до выбора кривой и точки, предоставляемой OpenSSH. Подсчет порядка такой точки при заданных параметрах очевидно будет занимать больше 10 минут. Поэтому, при выполнении лабораторной работы я поставил задачу нахождения такой кривой и точки, время подсчета порядка которой будет как можно ближе к 10 минутам.

Все дальнейшие вычисления производились на ПК со следующими характеристиками:
- Процессор: AMD Ryzen 5 5500U with Radeon Graphics; частота 2.10 GHz; количество ядер 6;
- ОЗУ: 16 Гб; DDR 4

### Подбор параметров

При подборе параметров я начал с той идеи, что обычный перебор будет не самым лучшим решением, так как при очень больших значениях параметра $p$ мы будем пробовать замерять время на нахождение порядка точек, не опираясь ни на какие эвристики. Поэтому, при нахождении точки, вычисление порядка которой займет 5 минут, велика вероятность сначала пройти 20 точек, вычисление порядка которых займет по 1 минуте. Итого мы будем тратить в разы больше времени.

Поэтому первым этапом было сформировать стратегию поиска параметров, используя теоретическую основу эллиптических кривых. Первое, что я заметил - время вычисления порядка точки прямо пропорционально собственно ее порядку. Поэтому, если мы знаем, сколько времени потребуется на 1 итерацию, и требуемое время, с которым должен вычисляться порядок, то само значение порядка мы можем (очень грубо) аппроксимировать следующим выражением

$$
n_P = \frac{T}{s}
$$

где $n_P$ - порядок точки, $T$ - ожидаемое время вычисление порядка, $s$ - сколько времени требуется на 1 итерацию.

### Вычислительная мощность ЭВМ

Возникает проблема в поиске значения $s$. Для этого я написал небольшой скрипт на Python, который при не слишком большом параметре p начинает вычислять порядки всех точек кривой. Для каждой точки также вычисляется потраченное время. Далее, для каждой точки я посчитал отношение порядка к затраченному времени и нашел среднее арифметическое среди таких отношений.

![1](https://github.com/Nifacy/mai-labs/assets/95340036/8258fe22-1785-4a03-bcbb-9d7a500bd831)

Итого, мы получаем, что интересующая нас точка должна иметь порядок, близкий к найденному значению. Теперь задача сводится к нахождению:
- Параметра $p$, в котором будет интересующая нас точка
- Интересующей нас точки $P = (x, y)$

Так как полный перебор здесь будет крайне не эффективен, то я снова воспользовался теоретическими основами эллиптических кривых. Возьмем произвольную точку $P$, принадлежащую кривой с порядком $N$. Тогда, из теоремы Лагранжа следует, что порядком точки $P$ является один из делителей $N$. Также, по определению, порядком точки $P$ является такое число $n$, что $n \cdot P = 0$. Итого, мы приходим к следующей стратегии поиска параметров:

- Возьмем произвольный $p$.
- Для кривой с таким параметров ищем ее порядок $N$.
- Находим все делители $N$ и берем из них максимальный - $n$.
- Возьмем точку $P$, принадлежащую кривой.
- Если $n \cdot P = 0$ и при всех делителях $k$ меньших $n$, это равенство не соблюдается, то мы можем сказать, что порядок текущей точки $P$ равен $n$.

Теперь задача сводится к поиску порядка самой эллиптической кривой и более эффективному вычислению умножения, так как сейчас он ни чем не отличается от сложения за линейное время.

### Поиск порядка кривой

Поиск порядка кривой является "сложной" задачей. Это означает, что она не может быть выполнена достаточно быстро на современных машинах.

Самое простое решение - посчитать количество точек, принадлежащих кривой. В этом случае мы проходимся по всем возможных значениям $(x, y)$, где каждая координата может иметь целое значение в диапазоне $[0; p)$, проверяем каждую точку на принадлежность. Однако, как видно из описания алгоритма, его временная сложность составляет $O(p ^ 2)$, из-за чего алгоритм становится пригодных при не очень больших $p$.

Однако, есть улучшенный алгоритм, который имеет такой же смысл - подсчет всех точек. Этот алгоритм основывается на той идее, что в уравнении эллиптической кривой, левая и правая часть содержат ровно по 1 координате. Итого, мы можем пройтись по всем возможным значениям $x \in [0; p)$, $y \in [0; p)$, для каждой части посчитать значение соответствующей части и сохранить результат.

Результат сохраняется в виде отображения "значение" $\rightarrow$ "кол-во значений координаты". Далее, нам нужно пройтись по всем возможных значениям, взять кол-во значения каждой координаты и перемножить их. Суммой всех найденных значений и будет порядок кривой.

Такой способ работает уже за линейную сложность $O(p)$, однако, он его пространственная сложность также увеличивается - $O(p)$. Итого, при значениях $p \sim 10 ^ 6$ нам придется хранить уже 2 словаря по миллиону элементов, что крайне затратно по памяти, и алгоритм становится непригодным при огромных значениях $p$.

Однако, существует алгоритм Шуфа, который эффективно делает подсчет числа точек на эллиптической кривой над конечным полем. Для этого я использовал уже готовую реализацию алгоритма Шуфа, представленную в виде исполняемого файла.

Далее, путем подбора значения $p$ я нашел такую кривую, у которой порядок был больше интересующего нас количества итераций, так как значения ниже нас не интересуют ведь все делители такого числа будут меньше, и максимальный делитель которого также больше интересующего нас количества.

![2](https://github.com/Nifacy/mai-labs/assets/95340036/1dd75c39-e07d-43a6-912c-0f6417cfb6cd)

![3](https://github.com/Nifacy/mai-labs/assets/95340036/95dd8c1a-4c40-4bd2-8686-24ffe80b9dc9)

Ближе всего к интересующему меня количеству итераций оказалось значение 356727504, которое соответствует значению $p$, равному 713484217.

### Поиск точки

И так, мы выяснили, что кривая с параметрами $a = 1$, $b = 7$, $p = 713484217$ содержит точку, порядок которой удовлетворяет нашим требованиям. В итоге, остается найти конкретную точку с необходимым порядком.

Так как вычислять порядок каждой точки "прямо" будет занимать слишком много времени, я решил использовать более оптимизированный способ, основанный на определении порядка точки.  Как упоминалось ранее, порядком точки называется такое $n$, что $n \cdot P = 0$. Поэтому, достаточно пройтись по всем делителям порядка кривой и посмотреть, при каком делителе результатом будет равен нулевой (бесконечно удаленной) точке.

Для более оптимального вычисления произведения $n \cdot P$ я воспользовался стандартным алгоритмов бинарного умножения, который часто применяется на практике. Его суть заключается в представлении числа $n$ в двоичном виде

$$
n = a_0 \cdot 2 ^ 0 + a_1 \cdot 2 ^ 1 + a_2 \cdot 2 ^ 2 + \ldots
$$

В таком виде значение умножения может быть вычислено за $O(\log n)$ вместо $O(n)$.

![4](https://github.com/Nifacy/mai-labs/assets/95340036/64a70dc4-73e9-4f57-a682-e5d0a4472d32)

Итого, мы видим, что точка $(12, 667221373)$ имеет порядок 356727504. Это значение близко к интересующему нас, что дает нам основания предполагать, что подсчет такой точки будет занимать около 10 минут.

### Расчет порядка точки

Проверим нашу теорию на практике, посчитав перебором порядок точки $(12, 667221373)$ на кривой $(1, 7, 713484217)$. Для этого я написал скрипт на Python, который путем использования операции сложения до тех пор, пока не получит результат $(0, 0)$, вычисляет порядок точки.

![5](https://github.com/Nifacy/mai-labs/assets/95340036/2ff45015-d1f2-4a0e-a9cc-f150de2f5b99)

## Выводы

В ходе выполнения данной лабораторной работы я выполнил поиск эллиптической кривой и точки, вычисление порядка которой наивным способом занимает кооло 10 минут на ПК.

Я на практике убедился, почему в современных конфигурациях эллиптических кривых, предоставляемых, например, OpenSSH, параметр $p$ имеет такие большие значения. Я также понял, что точка $P$ не выбирается произвольным образом, а выбирается такая, которая будет удовлетворять необходимым требованиям безопасности.

В ходе данной лабораторной работы я убедился, на сколько неэффективно наивное решение для задачи нахождения порядка точки, которая является частным случаем задачи дискретного логарифмирования. В настоящее время существуют более оптимизированные алгоритмы нахождения порядка точки, такие как алгоритм **$\rho$ Полларда** и **Baby-step giant-step**.

Эллиптические кривые могут служить заменой традиционным методам криптографии, таким как RSA. 

Эллиптические кривые имеют ряд преимуществ по сравнению с RSA, что похволяет им быть хорошей заменой:

1. Более высокая эффективность: Эллиптические кривые требуют меньше вычислительных ресурсов для генерации ключей, шифрования и дешифрования.

2. Меньший размер ключа: Для достижения такого же уровня криптостойкости, как и в RSA, требуются ключи меньшего размера. Это уменьшает затраты на хранение и передачу информации.

3. Безопасность: На сегодняшний день неизвестны субэкспоненциальные алгоритмы для решения задачи дискретного логарифмирования в группах точек эллиптических кривых.

## Список используемой литературы

- "Доступно о криптографии на эллиптических кривых" Хабр: https://habr.com/ru/articles/335906/

- Статья на сайте secuteck: http://secuteck.ru/articles2/Inf_security/elept_krivaya_nov_etap_razv_kripto

- "Что такое шифрование на основе эллиптических кривых" keepersecurity: https://www.keepersecurity.com/blog/ru/2023/06/07/what-is-elliptic-curve-cryptography/
